# 脚本说明

本目录包含项目的构建和发布脚本。

## 脚本列表

### `sync-swot.ts`

同步 JetBrains swot 仓库到本地。

**运行方式：**

```bash
npm run sync:swot
```

**功能：**

- 首次运行时会克隆 swot 仓库到 `swot/` 目录
- 后续运行会拉取最新的更新
- 自动处理 main/master 分支

### `generate.ts`

从 swot 仓库生成树状数据结构。

**运行方式：**

```bash
npm run generate
```

**功能：**

- 遍历 swot 仓库的所有域名文件
- 生成优化的树状 JSON 数据结构
- 处理 stoplist 和 abused 域名
- 输出到 `data/tree.json`

**压缩选项：**

- 紧凑 JSON（无格式化）
- 短键名（`_n_` 代替 `__names__`）
- 去重学校名称
- 可选 gzip 压缩

### `release.ts` 🚀

**一键发布脚本** - 自动化完整的发布流程。

**运行方式：**

```bash
npm run release
```

**完整流程：**

1. **检查 Git 状态**

   - 检查是否有未提交的更改
   - 显示当前分支

2. **同步 swot 仓库**

   - 拉取最新的教育机构域名数据

3. **生成数据文件**

   - 构建树状数据结构

4. **构建生产代码**

   - 编译 TypeScript
   - 生成多种格式（ESM、CJS）
   - 生成类型声明文件

5. **运行测试**

   - ✅ **单元测试** (vitest) - 必须运行
   - **功能测试** (可选)
     - 示例验证测试
     - 树结构测试
   - **性能测试** (可选)
   - 测试失败时可选择是否继续

6. **更新版本号**

   - 选择版本更新类型：
     - `patch` - 补丁版本 (0.2.0 → 0.2.1)
     - `minor` - 次版本 (0.2.0 → 0.3.0)
     - `major` - 主版本 (0.2.0 → 1.0.0)
     - `custom` - 自定义版本号

7. **Git 提交和标签**

   - 添加所有更改
   - 创建版本提交
   - 创建版本标签
   - 可选推送到远程仓库

8. **发布到 npm**
   - 检查 npm 登录状态
   - 确认后发布到 npm registry
   - 显示包的 npm 地址

**示例输出：**

```
========================================
  JBS-SWOT-EMAIL 发布脚本
========================================

检查git状态...
当前分支: main

▶ 同步 swot 仓库
✓ 同步 swot 仓库 完成

▶ 生成数据文件
✓ 生成数据文件 完成

▶ 构建生产代码
✓ 构建生产代码 完成

========================================
运行测试套件
========================================

▶ 运行单元测试 (vitest)
✓ 运行单元测试 (vitest) 完成

是否运行功能测试和性能测试? (y/n): y

▶ 运行示例验证测试
✓ 运行示例验证测试 完成

========================================
选择版本号更新类型:
  1) patch  - 补丁版本 (0.2.0 -> 0.2.1)
  2) minor  - 次版本 (0.2.0 -> 0.3.0)
  3) major  - 主版本 (0.2.0 -> 1.0.0)
  4) custom - 自定义版本号
========================================

请选择 (1/2/3/4): 1

✓ 新版本号: 0.2.1

是否提交更改到 git? (y/n): y
✓ 添加更改到暂存区 完成
✓ 提交更改 完成
✓ 创建 git 标签 完成

是否推送到远程仓库? (y/n): y
✓ 推送提交 完成
✓ 推送标签 完成

========================================
准备发布到 npm
========================================

确认发布到 npm? (y/n): y
当前 npm 用户: rabithua

▶ 发布到 npm
✓ 发布到 npm 完成

========================================
✓ 发布完成!
========================================
版本: 0.2.1
包名: jbs-swot-email
查看: https://www.npmjs.com/package/jbs-swot-email
========================================
```

## 前置条件

### 开发依赖

确保已安装所有依赖：

```bash
npm install
```

### npm 认证

发布到 npm 前需要登录：

```bash
npm login
```

### Git 配置

确保 Git 已正确配置：

```bash
git config user.name "Your Name"
git config user.email "your.email@example.com"
```

## 常见问题

### Q: 测试失败了怎么办？

A: 脚本会询问是否继续发布。建议修复测试问题后再发布。

### Q: 可以跳过某些步骤吗？

A: 同步、生成、构建是必须的。测试和 Git 操作可以选择性执行。

### Q: 如何回滚版本？

A: 如果发布有问题，可以：

```bash
# 回滚 npm 版本（需要 npm owner 权限）
npm deprecate jbs-swot-email@<version> "有问题，请使用其他版本"

# 或发布修复版本
npm run release
```

### Q: 版本号选择建议？

A: 遵循语义化版本规范：

- **patch**: 向后兼容的 bug 修复
- **minor**: 向后兼容的新功能
- **major**: 不向后兼容的重大更改

## 手动发布流程

如果需要手动执行各个步骤：

```bash
# 1. 同步数据
npm run sync:swot

# 2. 生成数据
npm run generate

# 3. 构建
npm run build

# 4. 测试
npm test
npm run test:example
npm run test:tree

# 5. 更新版本
npm version patch  # 或 minor/major

# 6. Git 提交
git add .
git commit -m "chore: release vX.X.X"
git tag vX.X.X
git push
git push --tags

# 7. 发布
npm publish
```

## 许可证

MIT License - 详见项目根目录 LICENSE 文件
